machine:
  services:
    - docker 
  environment:
    GOPATH: /home/ubuntu/.go_workspace
    IMPORT_PATH: github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME
    COVERALLS_REPO_TOKEN: 3QBLcfjGKHMtQevf0Q0lkADeRpUdscmdS
general:
  build_dir: ../.go_workspace/src/$IMPORT_PATH
checkout:
  post:
    - mkdir -p "$GOPATH/src/$IMPORT_PATH"
    - rsync -azC --delete $HOME/$CIRCLE_PROJECT_REPONAME/ $GOPATH/src/$IMPORT_PATH/
dependencies:
  override:
    - go get -v ./...
    - go get -v golang.org/x/tools/cmd/cover
    - go get -v github.com/mattn/goveralls
    - cd $GOPATH/src/$IMPORT_PATH/src && go build -v
test:
  override:
    - cd $GOPATH/src/$IMPORT_PATH/tests && go test -v -cover -covermode=count -coverprofile=coverage.out
    - cd $GOPATH/src/$IMPORT_PATH/tests && $GOPATH/bin/goveralls -v -coverprofile=coverage.out -service=circle-ci -repotoken $COVERALLS_REPO_TOKEN
  post:
    - cd $GOPATH/src/$IMPORT_PATH && docker build -t rctyler/todo.api.go .
    - docker save rctyler/todo.api.go | gzip > $CIRCLE_ARTIFACTS/todo-api-go.tar.gz
    - cp ./deploy/docker-compose.yml $CIRCLE_ARTIFACTS/docker-compose.yml

